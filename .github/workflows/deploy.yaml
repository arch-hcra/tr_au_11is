name: Deploy Infrastructure
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Kubernetes tools
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.30.0'

    - name: Setup Kustomize
      uses: imranismail/setup-kustomize@v1
      with:
        kustomize-version: '5.3.0'

    - name: Configure Kubernetes context
      run: |
        kubectl config set-cluster production \
          --server=${{ secrets.FRST_API }} \
          --insecure-skip-tls-verify=true
        kubectl config set-credentials github-actions \
          --token=${{ secrets.FRST_TOKEN_SECRET }}
        kubectl config set-context production \
          --cluster=production \
          --user=github-actions \
          --namespace=default
        kubectl config use-context production

        kubectl cluster-info
        kubectl get nodes

    - name: Validate manifests with dry-run
      run: |
        if [ -d "infrastructure/base" ]; then
          kustomize build infrastructure/base/ --load-restrictor LoadRestrictionsNone > /tmp/manifests.yaml
          kubectl apply --dry-run=server -f /tmp/manifests.yaml
          echo " Manifests validation passed"
        else
          echo " infrastructure/base directory not found, skipping validation"
        fi

    - name: Deploy Base Infrastructure
      run: |
        if [ -d "infrastructure/base" ]; then
          kubectl apply -k infrastructure/base/ --server-side=true
          echo " Base infrastructure deployed"
        else
          echo " infrastructure/base directory not found, skipping deployment"
        fi

    - name: Wait for resources readiness
      run: |
        
        if kubectl get deployment -n calico-system calico-kube-controllers 2>/dev/null; then
          kubectl wait --for=condition=ready pod -l k8s-app=calico-kube-controllers -n calico-system --timeout=600s || true
        fi
        
        if kubectl get deployment -n kyverno kyverno 2>/dev/null; then
          kubectl wait --for=condition=ready pod -l app=kyverno -n kyverno --timeout=600s || true
        fi

        echo " Readiness checks completed"

    - name: Verify deployment status
      run: |
        echo "=== Cluster overview ==="
        kubectl get nodes -o wide
        echo "=== Pods status ==="
        kubectl get pods -A --field-selector=status.phase!=Running
