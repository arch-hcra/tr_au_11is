name: Deploy Infrastructure
on:
  push:
    branches: [ main ]
    paths:
      - 'infrastructure/base/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Kubernetes tools
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.30.0'

    - name: Setup Kustomize
      uses: kubernetes-sigs/kustomize-action@v1
      with:
        kustomize-version: 'v5.3.0'

    - name: Configure Kubernetes context
      run: |
        kubectl config set-cluster production \
          --server=${{ secrets.K8S_SERVER }} \
          --insecure-skip-tls-verify=true
        kubectl config set-credentials github-actions \
          --token=${{ secrets.K8S_TOKEN }}
        kubectl config set-context production \
          --cluster=production \
          --user=github-actions \
          --namespace=default
        kubectl config use-context production
        
        kubectl cluster-info
        kubectl get nodes

    - name: Validate manifests with dry-run
      run: |
        kustomize build infrastructure/base/ --load-restrictor LoadRestrictionsNone > /tmp/manifests.yaml
        kubectl apply --dry-run=server -f /tmp/manifests.yaml
        echo " Manifests validation passed"

    - name: Deploy Base Infrastructure
      run: |
        kubectl apply -k infrastructure/base/ --server-side=true
        echo " Base infrastructure deployed"

    - name: Wait for resources readiness
      run: |
        kubectl wait --for=condition=ready pod -l k8s-app=calico-node -n calico-system --timeout=600s
        kubectl wait --for=condition=ready pod -l k8s-app=calico-kube-controllers -n calico-system --timeout=600s
        
        kubectl wait --for=condition=ready pod -l app=kyverno -n kyverno --timeout=600s
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=kyverno-admission-controller -n kyverno --timeout=600s
        
        kubectl wait --for=condition=ready pod -l k8s-app=kube-dns -n kube-system --timeout=300s
        
        echo " All critical components are ready"

    - name: Verify deployment status
      run: |
        echo "=== Cluster overview ==="
        kubectl get nodes -o wide
        echo "=== Pods status ==="
        kubectl get pods -A --field-selector=status.phase!=Running
        echo "=== Running pods count ==="
        kubectl get pods -A --no-headers | grep Running | wc -l
