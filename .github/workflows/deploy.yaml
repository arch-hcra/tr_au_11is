name: Deploy Kubernetes Infrastructure

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CLUSTER_NAMESPACE: default
  BASE_PATH: infrastructure/base

jobs:
  validate:
    name: Validate All Manifests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Kustomize
      uses: imranismail/setup-kustomize@v1
      with:
        kustomize-version: '5.3.0'

    - name: Validate Root Kustomization
      run: |
        echo "ðŸ” Validating root kustomization..."
        kustomize build $BASE_PATH --load-restrictor LoadRestrictionsNone > /dev/null
        echo " Root kustomization validated"

    - name: Validate Sub-components
      run: |
        echo "ðŸ” Validating all sub-components..."
        
       
        components=("calico" "istio" "kyverno")
        
        for component in "${components[@]}"; do
          if [ -d "$BASE_PATH/$component" ]; then
            echo " Validating $component..."
            kustomize build "$BASE_PATH/$component" --load-restrictor LoadRestrictionsNone > /dev/null
            echo " $component validated"
          else
            echo " Component $component not found"
          fi
        done

    - name: Validate YAML Syntax
      run: |
        echo "ðŸ” Validating YAML syntax for all manifests..."
        
        
        kustomize build $BASE_PATH --load-restrictor LoadRestrictionsNone > /tmp/all-manifests.yaml
        
        
        python3 -c "
        import yaml, sys
        try:
            with open('/tmp/all-manifests.yaml', 'r') as f:
                docs = list(yaml.safe_load_all(f))
            print(f' YAML syntax valid ({len(docs)} documents)')
        except Exception as e:
            print(f' YAML validation failed: {e}')
            sys.exit(1)
        "

  deploy:
    name: Deploy to Cluster
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Kubernetes tools
      uses: azure/setup-kubectl@v3

    - name: Setup Kustomize
      uses: imranismail/setup-kustomize@v1
      with:
        kustomize-version: '5.3.0'

    - name: Authenticate with Cluster
      run: |
        echo " Configuring Kubernetes access..."
        
        cat > kubeconfig.yaml << EOF
        apiVersion: v1
        kind: Config
        clusters:
        - name: production
          cluster:
            server: ${{ secrets.FRST_API }}
            insecure-skip-tls-verify: true
        users:
        - name: github-actions
          user:
            token: ${{ secrets.FRST_TOKEN_SECRET }}
        contexts:
        - name: production
          context:
            cluster: production
            user: github-actions
            namespace: $CLUSTER_NAMESPACE
        current-context: production
        EOF
        
        export KUBECONFIG=kubeconfig.yaml
        
        
        echo "ðŸ“¡ Testing cluster connection..."
        kubectl cluster-info
        kubectl get nodes

    - name: Dry Run Deployment
      run: |
        export KUBECONFIG=kubeconfig.yaml
        echo " Performing server-side dry-run..."
        
        # Dry-run Ð´Ð»Ñ Ð²ÑÐµÐ³Ð¾
        kustomize build $BASE_PATH --load-restrictor LoadRestrictionsNone | \
          kubectl apply --server-side --dry-run=server -f -
        
        echo " Dry-run validation passed"

    - name: Deploy Components Sequentially
      run: |
        export KUBECONFIG=kubeconfig.yaml
        echo " Deploying components sequentially..."
        
        
        components=("calico" "istio" "kyverno")
        
        for component in "${components[@]}"; do
          if [ -d "$BASE_PATH/$component" ]; then
            echo " Deploying $component..."
            kustomize build "$BASE_PATH/$component" --load-restrictor LoadRestrictionsNone | \
              kubectl apply -f -
            
            
            if [ "$component" == "calico" ]; then
              echo " Waiting for Calico to be ready..."
              sleep 30
            elif [ "$component" == "istio" ]; then
              echo " Waiting for Istio to be ready..."
              sleep 60
            fi
            
            echo " $component deployed"
          else
            echo " Component $component not found, skipping"
          fi
        done

    - name: Verify Deployment
      run: |
        export KUBECONFIG=kubeconfig.yaml
        echo " Verifying deployment status..."
        
       
        sleep 60
        
        echo " Checking namespaces..."
        kubectl get namespaces
        
        echo " Checking pods in all namespaces..."
        kubectl get pods --all-namespaces
        
        echo " Checking custom resources..."
        kubectl get crd --no-headers | wc -l | xargs echo "CRDs installed:"
        
        echo " Deployment verification completed"
